## Goal
We want to develop an Android firmware modification that uses a FIDO key (like a YubiKey) plugged into the phone's USB port to decrypt the phone's storage during boot. After boot, the USB port should revert to charging-only mode, and the FIDO key can be removed. Rebooting requires the key again.
## Milestones
для разработки прошивки Android с FIDO-ключом для расшифровки:

### 0: Исследование и Подготовка

- **Цель:** Оценить техническую реализуемость, выбрать целевое устройство и версию Android, подготовить среду разработки.
- **Задачи:**
    - Анализ возможности интеграции USB драйверов и FIDO библиотек в среду bootloader.
    - Выбор конкретной модели телефона и версии AOSP для модификации.
    - Настройка сборочной среды для выбранного устройства.
    - Получение возможности сборки и прошивки модифицированного образа.
- **Результат:** Подтвержденная (на уровне теории и предварительных тестов) возможность реализации, настроенная среда разработки, базовый образ Android, собранный и прошитый на целевое устройство.

### 1: Интеграция USB и FIDO

- **Цель:** Обеспечить обнаружение и базовое взаимодействие с FIDO ключом на этапе работы загрузчика.
- **Задачи:**
    - Интеграция минимально необходимых USB драйверов (host-mode, HID-device support) в загрузчик (возможно портирование из recovery system, где этот функционал уже есть)
    - Интеграция библиотеки для работы с FIDO протоколом (U2F).
    - Разработка сервиса, запускаемого на этапе инициализации, который может обнаружить подключенный FIDO ключ и выполнить считывание ключа.
- **Результат:** сервис способный определить подключенный FIDO ключ и получить от него ключ шифрования (хотя бы просто в виде логов в консоли).
### 2: Реализация процесса расшифровки диска
- **Цель:** реализовать механизм расшифровки устройства с помошью FIDO ключа.
- **Задачи:**
    - Анализ существующего механизма шифрования Android (FDE - Full Disk Encryption на базе dm-crypt (deprecated) или FBE - File-Based Encryption на базе dm-default-key).
    - Модификация процесса загрузки для реализации схемы:
        - Показ экрана запроса пароля
        - Вызов сервиса работы с FIDO ключом
        - Получение ключа для расшифровки
        - Передача этого ключа механизму расшифровки для монтирования зашифрованных разделов.
- **Результат:** При загрузке телефон ожидает FIDO ключ. После успешного считывания ключа с токена происходит расшифровка и дальнейшая загрузка Android.

### 3: Реализация процесса первоначального шифрования

- **Цель:** Создать механизм для первоначального шифрования телефона с привязкой к конкретному FIDO ключу.
- **Задачи:**
    - Разработка процесса, который выполняется при первом запуске или при включении шифрования:
    - Интеграция этого процесса в стандартный мастер настройки Android или создание отдельного приложения/меню настроек.
- **Результат:** Пользователь может зашифровать телефон, связав его с FIDO ключом. После этого телефон можно перезагрузить, и он потребует этот ключ для расшифровки.

### 4: смена режима работы USB после загрузки

- **Цель:** Переключить USB порт в режим "только зарядка" после успешной расшифровки и загрузки основной системы Android.
- **Задачи:**
    - Найти способ программного управления конфигурацией USB контроллера.
    - Реализовать переключение USB порта в режим, где линии данных отключены, но питание для зарядки подается.
- **Результат:** После полной загрузки Android USB порт устройств работает только для зарядки. Передача данных (или использование ADB) невозможно.

### 5: Тестирование и Стабилизация 

- **Цель:** Обеспечить стабильную и надежную работу всего функционала в различных сценариях.
- **Задачи:**
    - Тестирование полного цикла: шифрование -> перезагрузка -> расшифровка с ключом -> работа -> извлечение ключа -> перезагрузка -> невозможность загрузки без ключа.
    - Тестирование граничных случаев: извлечение ключа во время расшифровки, подключение неправильного ключа, сбои USB, разряд батареи во время загрузки.
    - Тестирование безопасности: попытки обхода механизма расшифровки.
    - Исправление ошибок, оптимизация кода.
- **Результат:** Стабильная прошивка, реализующая user story, с минимальным количеством багов.

### 6: Документация и Релиз

- **Цель:** Подготовить необходимую документацию для пользователей и разработчиков.
- **Задачи:**
    - Написание руководства пользователя (как настроить, как использовать, что делать при потере ключа – возможно, нужен резервный способ?).
    - Создание технической документации (описание архитектуры, процесса сборки, внесенных изменений).
    - Подготовка финальной сборки прошивки.
- **Результат:** Готовый к распространению (или внутреннему использованию) образ прошивки и сопутствующая документация.
