## Концепт
Мы хотим создать два сайта.

Простой лендинг для SEO и продвижения (с посадочными страницами для привлечения клиентов и т.п.). Он должен располагаться в корне домена, например vgen.com. Это набор абсолютно статичных HTML-страниц без бэкенда.

Административная панель для регистрации и управления заданиями. Её можно разместить на поддомене app.vgen.com. Для административной панели мы будем использовать SSR с проверкой session cookie для контроля доступа к целевым разделам.

## User Stories
Как пользователь я хочу:

### Регистрация/Верификация
Иметь возможность зарегистрироваться, используя email и пароль. Неверифицированный аккаунт не может войти в систему (при попытке авторизации будет показано сообщение о необходимости верификации). Для верификации я должен зайти в почту и перейти по ссылке активации. Ссылка работает в течение 24 часов. При попытке авторизации или сброса пароля для неактивированного email мне приходит ссылка на активацию аккаунта.

### Сброс пароля
Иметь возможность сбросить пароль в случае, если я его забыл. Ожидаю, что мне придёт ссылка на сброс пароля. Ссылка активна в течение 24 часов.

### Авторизация
Иметь возможность войти в систему, используя логин и пароль, установленные при регистрации.

### Просмотр баланса
Иметь возможность увидеть текущий баланс токенов.

### Просмотр истории изменений баланса
Иметь возможность увидеть, когда и как изменялся баланс.

### Пополнение баланса
Иметь возможность пополнить баланс на заданные суммы. Например:
- 10 000 токенов — 10 USD
- 30 000 токенов — 25 USD
- 70 000 токенов — 50 USD

> Важно: Мы не предусматриваем подписочную модель на токены. Только предоплата.

### Просмотр списка заданий
Иметь возможность посмотреть список всех созданных мною заданий в системе.

### Создание нового задания
Иметь возможность создать новое задание, выбрав тип модели.

### Редактирование созданного задания
Иметь возможность зайти в созданное задание для загрузки в него материалов (видео, аудио).
### Запуск задания
Иметь возможность запустить ранее созданное и отредактированное задание.

### Просмотр статуса выполнения задания
Иметь возможность посмотреть статус выполнения ранее созданных заданий.

### Загрузка результата выполнения задания
Иметь возможность загрузить результат выполнения задания.

### Перегенерация выполненного задания
Иметь возможность запустить перегенерацию задания в случае, если результат мне не понравился (без повторной загрузки данных).

## Макеты приложения
![vgen-auth.png](./attachments/vgen-auth.png)
![[vgen-dashboard.png]]
![vgen-task.png](./attachments/vgen-task.png)
![vgen-tokens.png](./attachments/vgen-tokens.png)
![vgen-usage.png](./attachments/vgen-usage.png)
## Landing
Лендинг должен содержать:
- Посадочную страницу с информацией о продукте
- Страницу Terms of Service
- Страницу Privacy Policy

Все страницы должны иметь call-to-action — переход на страницу регистрации в продукте.

Посадочная страница должна содержать примеры уже сгенерированных клипов (оптимально 5-10 в разных категориях).

Посадочная страница не должна содержать блок с описанием цен — только указание на то, что токены можно купить внутри приложения, и общие фразы о доступности цен.

Посадочная страница должна иметь ссылку на бота поддержки в Telegram.

В лендинге должна быть возможность добавления отдельных страниц при необходимости (делать это при помощи кода, лендинг не должен ломаться от таких изменений).

Лендинг не поддерживает многоязычность — он создается только на английском языке.

SEO-оптимизация находится вне области задач этапа MVP.

## Приложение (APP)
Приложение является MPA с поддержкой session-based авторизации. Приложение не требует SEO или SSR, поскольку отсутствует доступ для неавторизованных пользователей. Приложение не поддерживает многоязычность. В дизайне приложения мы используем стандартные компоненты — максимально простой, но функциональный дизайн. Мы не создаем custom-вёрстку и не делаем специальных элементов интерфейса.

### Сохранение данных в DWH (BigQuery)
Помимо хранения балансов и данных о пользователях в D1, мы хотим сохранять в BigQuery некоторые данные для дальнейшего анализа.

#### Пользовательские сессии
При каждой авторизации пользователя я хочу сохранять:
- `timestamp` — время авторизации
- `ip` — IP-адрес
- `geo` — географические данные
- `useragent` — данные браузера/устройства
- `action` — тип действия: `login`/`signup` (вход или регистрация)
- `userid` — идентификатор пользователя
- `email` — email пользователя в системе

#### Изменения баланса токенов
Каждое изменение баланса или попытка изменения баланса должны быть сохранены в отдельной таблице:
- `timestamp` — время транзакции
- `userid` — идентификатор пользователя
- `email` — email пользователя
- `action` — тип действия: `topup`, `used`, `manual`
- `diff` — количество токенов, на которое произведено изменение
- `old_balance` — баланс до транзакции
- `new_balance` — баланс после транзакции

**Важно:** здесь мы не отражаем попытки оплаты или любые иные финансовые операции — это именно лог изменений количества токенов, привязанных к пользователю.

#### Лог запуска генераций
У нас нет доступа к логам API, но для отладки нам нужно хранить информацию о том, когда и какие задания мы запускали. Поэтому нам нужна таблица, где будет указано, когда и какой пользователь запускал какие задания и с какими ID. Наше API забывает (удаляет) истекшие задания, без такого лога у нас будут проблемы:
- `timestamp` — время запуска
- `userid` — идентификатор пользователя
- `email` — email пользователя
- `taskid` — идентификатор задания
- `task_properties` — свойства задания (to be defined)

## Admin API
В связи с тем, что мы не делаем административную панель, нам необходима возможность ручного управления пользователями и балансами.

Все API имеют защиту при помощи фиксированного `admin-token`, который необходимо передавать в заголовке `Authorization`. Токен задается в переменных окружения приложения.

### Изменение статуса пользователя
```
PUT /api/internal/user
{
  "userID": "njknjk",
  "status": "activated | new | blocked"
}
```

Метод необходим для ручной активации пользователя, который не может получить письмо активации, или блокировки пользователя, с которым мы больше не хотим работать.

### Изменение баланса пользователя
```
PUT /api/internal/balance
{
  "userID": "ndskd",
  "diff": "100 | -100"
}
```

Метод должен возвращать информацию о старом балансе, изменении и новом итоговом балансе. При помощи метода можно как увеличивать, так и уменьшать количество токенов у пользователя.

## Analytics
Для сбора веб аналитики на сайте должен быть установлен Google Tag Manager. При этом для авторизированных пользователей должен передаваться userId и email пользователя в dataLayer. Внутрь GTM должен быть положен GA, который бы трекал page-views и userID dimension. Дальнейшая настройка GA - out of scope.

Для анализа данных из BigQuery мы подключим MetaBase (его развёртывание находится вне области задач проекта, он у нас уже есть, и мы просто выдадим доступ заданному списку пользователей).

### Управление стоимостью токена
В проекте будет создан конфиг, к примеру prices.ts, следующего формата:
```typescript
prices = [
  {
  name: "small",
  price: 1000, // 10usd, denomination 100
  tokens: 10_000
  },
  {
  name: "medium",
  price: 3000, // 30usd, denomination 100
  tokens: 30_000
  },
   {
  name: "large",
  price: 5000, // 50usd, denomination 100
  tokens: 70_000
  }
]
```
Таким образом, при необходимости изменить ценообразование необходимо будет внести правки в конфиг. При этом уже приобретённые токены никуда не деваются и не переоцениваются. При необходимости можно делать разные бандлы, регулируя стоимость токена таким образом (к примеру крупным покупателям стоимость может выходить дешевле)

### Платежная система
Как платежное решение мы подключим https://api.apay.pp.ua/docs/api.
Под капотом будет onramp-решение для криптовалют. При необходимости можно будет подключить что-то ещё. В целом идея — отделить платежную систему от сервиса, поскольку они могут меняться (отключаться, восстанавливаться и т.п.).



