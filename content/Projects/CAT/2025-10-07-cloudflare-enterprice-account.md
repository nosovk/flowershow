# Goal: описать как можно экономить на enterprice accounts CF для продуктов nextcode

### Input:
На данный момент мы релизуем следующую схему работы для CIS гео:

user => fastly (mirror1.com, mirror2.com) => cf (origin.domain.com) => nextcode (origin.nc.com)

То есть трафик приходит на fastly, который обслуживает большое количество доменов (при необходимости мы можем заменить fastly на что-то еще).

Fastly забирает контент с CloudFlare, как с источника.

Мы хотим использовать CloudFlare для возможности гибкого использования Rate Limits, Caching Etc. Фактически он нам нужен, чтобы в случае проблем ограничить нагрузку на origin NC.
Чтобы CF мог справляться с этой ролью, нам необходима enterprice feature для WAF и RateLimits - https://developers.cloudflare.com/waf/rate-limiting-rules/parameters/#use-cases-of-ip-with-nat-support

Вторая проблема которая у нас возникает в таком случае - L7 AntiDDOS, который не отключаем не на Enterprice Plan при увеличении нагрузки начинает банить Fastly (такая проблема у нас возникала с лендингами работающими по такой же схеме).

Из этих двух пунктов, мы приходим к выводу, что нам необходим Enterprice Domain для обслуживания NC проектов.

### Экономия
Мы хотим сэкономить на количестве Ent доменов. Нам достаточно одного домена, к примеру nc-system-intergation.com, где каждый поддомен реализовывал бы origin для fastly.
- motor.nc-system-intergation.com
- atom.nc-system-intergation.com
и т.д.

В этом случае у нас на одном enterprice домене будут находится все продукты NC. Для закрытия их от публичного доступа, мы можем блокировать все запросы без секретного заголовка на уровне WAF. Таким образом мы сохраним и возможность использовать rate limits, и домен спрячем, и origin NC прикроем


### Корень зла
Мы не смогли заменить CF rate limits другим продуктом. В целом, если реализовать замену - можно бы и от CF отказаться, но нам важно, чтобы терминацию осуществляло что-то, что имеет условно бесконечную емкость канала для реализации rate-limits, waf etc. Больше всего у нас в этом разрезе опыта с CF, но если ценник будет дорогим - можно попробовать использовать какой-то другой инструмент.