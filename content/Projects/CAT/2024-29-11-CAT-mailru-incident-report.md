# Incident
поступила жалоба от аффилиата о не возможности регистрации с mail.ru.

### Информация о том как происходит процесс регистрации
Процесс регистрации состоит из двух шагов.
- Validate: POST `casino.com/api/v1/validate/user-register`
- Register: POST `casino.com/api/v1/profiles`

После заполнения регистрационной формы происходит запрос `Validate`, с передачей всех параметров формы. Результатом валидации может быть либо набор сообщений об ошибках в заполнении полей, либо сообщение об успехе.
В случае успешной валидации происходит запрос на `Register`, в ходе которого уже происходит полная проверка корректности заполнения формы, которая может завершиться либо регистрацией пользователя, либо списком ошибок с асоциированными полями.

Почему именно такая механика? Метод `validate` не тригерит рейт лимиты со стороны SG, т.к. это в большинстве своем формальная проверка - в ней успешно можно указать несущетсвующий домен почты к примеру. В то время как метод `Register` уже имеет жесткие лимит ы
### Восстановленная хронология
- 19.01.2024: бал добавлен тестовый воркер, для блокировки регистрации с определенного списка доменов.
- В течение пары месяцев SG сделал свой функционал блеклистов и мы не использовали этот функционал
- 04.09.2024: мы начинаем делать воркеры для аналитики, создается [репозиторий](https://nodeart.app/git/projects/CAT/repos/cat.workers/browse) и начинает переноситься функционал старых воркеров. В процессе переноса функционал блокировки регистраций ломается (начинает всегда проверяться равна ли пустая строка запрещённому домену)
- 05.11.2024: происходит инцидент, в ходе которого у нас падает возможность доставлять письма на mail.ru. В ходе инцидента приходит запрос на блокирование mail.ru и показ ошибки в случае регистрации с mail.ru. Как срочная мера быстро добавлена блокировка
- 05.11.2024: где-то в этот же день от блокировки отказываемся, но в списке заблокированных остается мейл ру.
- 26.11.2024: приходит репорт от аффилиата о невозможности зарегаться с mail.ru. [репорт](https://i.imgur.com/KD6ItSi.png). 
- 26.11.2024: проверили и удалили из списка заблокированных доменов.
- 26.11.2024: в ходе тестирования выяснено, что ошибка происходит на уровне метода verify.
- 27.11.2024: проблема ушла, в ходе разбирательств обнаружено, что у нас нет никаких логов по работе метода verify. Как следствие мы не можем сказать что произошло. Мы знаем что наш метода на уровне `Register` не работал (была ошибка, нет событий блокировки в логах). Мы знаем что была ошибка от метода `Verify` который мы не используем. У нас нет никаких логов по методу `Verify` чтобы понять что происходило.
### Причины инцидента
- недостаток логирования критических для продукта параметров
- недостаток документации об уже реализованном функционале
### Принятые меры
- Добавлено логирование метода POST /api/v1/verify
  Таким образом мы получаем возможность мониторить всю цепочку регистрации
### Необходимые меры
- необходимо вернуть клиентское логирование ошибок, т.к. сейчас мы никак этот процесс не контролируем.
