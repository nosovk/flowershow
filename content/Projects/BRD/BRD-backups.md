# Бекапы
Бекапы бывают разные, глобально они отличаются по следующим критериям:
### Скоуп
Грубо говоря что мы собственно говоря бекапируем. К примеру wal-g делает бекап базы данных, а veeam делает бекап виртуальной машины целиком. У разных видов бекапов свой скоуп защищаемых данных.
Скоупы которые есть сейчас:
- физический сервер
- виртуальная машина
- база данных pimcore
- файлы внутри pimcore
- файлы в s3 storage
### Гранулярность
С какой точностью мы можем восстановить защищаемый скоуп. К примеру используя wal-g, который сохраняет transaction log изменений в базе данных, мы можем востановится на любой момент времени. То есть гранулярность бекапов грубо говоря одна минута. Или к примеру бекапы при помощи снепшота в hyper-v мы снимаем раз в сутки. Выходит что гранулярность hyper-v бекапов у нас сутки.
Гранулярности которые поддерживаются у нас:
- заданный момент времени, минута
- раз в сутки
- раз в неделю
- можно любые другие придумать
### Глубина
Как далеко мы хотим хранить бекапы. Для обьектов которые небольшие мы можем к примеру хранить бекапы за месяц или даже год. Пример: тот же wal-g, он будет хранить небольшие transaction logs, которые отражают фактическое изменение данных в бд. А к примеру хранить снепшоты всей виртуальной машины будет затратно по месту, и хранить их более чем на неделю назад не оправданно обычно.
Глубину хранения для каждого скоупа нужно обсудить отдельно

### Тип восстановления
Глобально бекапы делятся по типу восстановления: in place и не in place. Это определяет фактическое восстановление, происходит на старое место или в новое место. Если мы восстанавливаем бекап в новое место, то во-первых нужно это место, а во вторых процесс восстановления еще нужно продолжать, перенося восстановленные бекапы к месту их применения.
Пример in place restore: восстановление снепшотов в hyperv будет происходить на место существующей VM. Это очень быстро и с минимальным даунтаймом, но текущий стейт (поломанный) будет поломан.
## Схема бекапов
### Инкрементальные бекапы
Скоуп: база данных pimcore, файлы в pimcore
Гранулярность: минута, т.к. оба инструмента работают с diff
Тип восстановления: в новое место.

Используя [restic](https://github.com/restic/restic) и [walg](https://github.com/wal-g/wal-g), мы можем в S3 делать бекапы за любой период времени, причем бекапы могут быть зашифрованы. Поскольку хранится только diff и только самих данных PIM, мы можем позволить себе большую глубину хранения, к примеру пол года. Но такой вид бекапов не есть быстрым для восстановления. Поскольку если к примеру будет утеряна виртуальная машина или физический сервер — сначала нужно будет поднять новое окружение и уже затем в него восстанавливать бекапы.

Механизм этих бекапов уже есть, для их корректной работы необходимы от вас настройки отдельного S3 бакета для их хранения.


### hyper-v backups
Скоуп: виртуальная машина
Гранулярность: раз в день
Тип восстановления: in place restore.

Эти бекапы вы сейчас осуществляете, если мне не изменяет память раз в день. Глубина их хранения мне не известна. Основной плюс таких бекапов — возможность восстановить за пару минут. Основной минус — они занимают много места.

Эти бекапы нужно настроить с вашей стороны, в приемлемой форме.