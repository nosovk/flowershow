Goal: описать вариант реализации и необходимые шаги для реализации мобильного приложения казино в маркете.

Мы хотим иметь возможность закупать трафик с мобильных платформ. Для этого мы хотим опубликовать webview приложение в гуглплей и иос маркет, интегрировав его с приложениями для атрибуции трафика, и таким образом получить возможность закупать трафик из маркета напрямую на свой продукт.

## Риски:
- можно не получить разрешения на публикацию в связи с видом деятельности
- могут возникнуть проблемы с прохождением ревью из-за наличия только лишь webview
- могут возникнуть проблемы на этапе ревью в связи с использованием платежных методов отличных от googlepay\apple pay.

## Требования:
### - Интеграция с appsflyer. 
Для возможности работы с атрибуцией, то есть с utm метками на установку в маркете, необходимо интегрировать appsflyer sdk. Таким образом внутри мобильного приложения мы будем иметь возможность узнать параметры партнерской ссылки. К примеру app.store/my.app?stag=xxx.

Без реализации возможности работы с атрибуцией мы не сможем реализовать affiliate tracking, поэтому задача критично важна.


### - Интеграция с firebase
Если человек ставит на телефон мобильное приложение, то мы хотим иметь возможность слать ему push сообщения. На уровне мобильного приложения мы должны интегрировать firebase, и реализовать механизм передачи токенов firebase на бекенд, для дальнейшей отправки пушей. Для поддержки сегментации вероятно понадобится еще интеграция с onesignal.

### - интеграция с апи трекинга веб сайта
В платформе nextcode есть возможность сохранить данные об атрибуции до фактической регистрации, нам необходимо интегрироваться с апи некстода для передачи данных об атрибуции полученных из appsflyer.

### - интеграция механизма hot reload
Мы хотим иметь возможность менять часть обертки приложения в случае возникновения проблем, без повторного прохождения ревью. Для этого есть аналоги механизма hot reload, которые позволяют нам при необходимости изменить логику поведения приложения. 

Важно: это работает только с flutter кодом, работать с нативным кодом не будет увы.

### - реализация кастомных механизмов управления
Для работы с приложением в вебвью необходим некоторых дополнительный ux, чтобы к примеру свайп вниз перезагружал страницу, свайп влево не закрывал приложение со стартовой и т.п.

## Механизм коммуникации с сайтом
Разберем механизм коммуникации приложения и сайта на примере андроида.

- Мне необходимо внутрь браузера передать информацию об атрибуции (чтобы при регистрации пользователя у меня уже были данные партнера)
- Мне необходимо из бразуера передать в приложение информацию о пользователе (чтобы можно было к информации об устройстве для пушей прицепить данные об ид игрока (без этого onesignal или аналог не будет знать какого игрока этот телефон))


Реализация второго сценария на Android:
```kotlin
import android.webkit.JavascriptInterface;
 @JavascriptInterface
    public void addEventListener(String event) {
        Toast.makeText(mContext, "Event PASSED: " + event, Toast.LENGTH_SHORT).show();
        Log.e("WebAppInterface", "Received event: " + event);

        // Перевірка на null або undefined
        if (event == null || event.equals("undefined")) {
            Log.e("WebAppInterface", "Received null or undefined event");
            return;
        }

        try {
            // Перевіряємо, чи дані є валідним JSON-рядком
            JSONObject eventObject = new JSONObject(event);

            if (eventObject.has("userId")) {
                String userId = eventObject.getString("userId");

                Log.e("WebAppInterface", "User ID: " + userId);

            } else {
                Log.e("WebAppInterface", "Event does not contain expected fields.");
            }
        } catch (JSONException e) {
            Log.e("WebAppInterface", "JSON parsing error: " + e.getMessage());
        } catch (Exception e) {
            Log.e("WebAppInterface", "Unexpected error: " + e.getMessage());
        }
    }
}
```
Реализация передачи со стороны Web
```javascript
if (typeof Android == 'undefined') return;
  return Android.addEventListener(JSON.stringify({userId:"xxx"}))
```

Таким образом мы можем из веб сайта передать любую информацию в приложение. Аналогичный механизм есть и в обратную сторону.

### Методы которые необходимо реализовать со стороны сайта:
- передать userid в мобильную обертку
- получить affData из мобильной обертки
- получить fbMessageToken из мобильной обертки (возможно будет заменен на интеграцию onesignal или аналог в обертку)

В зависимости от того, будут ли какие-то дополнительные интеграции, к примеру customer.io и т.п. Возможно понадобятся доработки.

## Steps
- регистрация аккаунтов разработчика в ios\andorid, firebase, appsflyer, прохождение верификации
- настройка cicd для мобильной разработки (мы используем firebase app distribution)
- интеграция с nextcode
- публикация приложения

## Timelines
Регистрация аккаунтов заминает обычно до недели

Настройка cicd для мобильной разработки - осуществляется девопсом вместе с разработчиком, мы обычно используем выделенный билд агент для сборок на иос и андроид. Занимает обычно до недели.

Интеграция с nextcode - скорее всего растянется во времени (до месяца)